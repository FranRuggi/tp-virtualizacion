#!/bin/bash

# Validar directorio
if [ -z "$1" ]; then
  echo "Uso: $0 <directorio_de_encuestas>"
  exit 1
fi

DIR="$1"

# Procesar todos los archivos
awk -F"|" '
{
    # Extraer fecha (sin hora)
    split($2, fecha_hora, " ");
    fecha = fecha_hora[1];
    canal = $3;

    key = fecha "|" canal;
    tiempo[key] += $4;
    satisfaccion[key] += $5;
    cuenta[key]++;
}
END {
    for (k in cuenta) {
        split(k, arr, "|");
        fecha = arr[1];
        canal = arr[2];
        printf "%s|%s|%.2f|%.2f\n", fecha, canal, tiempo[k]/cuenta[k], satisfaccion[k]/cuenta[k];
    }
}' "$DIR"/*.txt |
jq -R -s '
    split("\n")[:-1] |
    map(split("|")) |
    reduce .[] as $item ({}; 
        .[$item[0]] += {
            ($item[1]): {
                tiempo_respuesta_promedio: ($item[2]|tonumber),
                nota_satisfaccion_promedio: ($item[3]|tonumber)
            }
        }
    )
'
